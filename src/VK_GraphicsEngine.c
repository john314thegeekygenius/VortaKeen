
/*
 * 
 * VortaKeen - A port of Commander Keen Invasion of the Vorticons for the Gameboy Advance
 * 
 * Started 06.17.22
 * 
 * Copyright (c) John314
 * 
 * Commander Keen is a trademark of ID software
 * 
*/


#include "VK_Headers.h"

volatile uint16_t* VK_GBA_BG_MAPA = (volatile uint16_t*)GBA_SCREEN_BLOCK(30);
volatile uint16_t* VK_GBA_BG_MAPB = (volatile uint16_t*)GBA_SCREEN_BLOCK(31);
volatile uint8_t* VK_GBA_BG_Tiles = (volatile uint16_t*)GBA_CHAR_BLOCK(0);
volatile uint8_t* VK_GBA_BG_Tiles2 = (volatile uint16_t*)GBA_CHAR_BLOCK(2);
volatile uint8_t* VK_GBA_BG_Tiles3 = (volatile uint16_t*)GBA_CHAR_BLOCK(2)+0x1000;
volatile uint8_t* VK_GBA_BG_TilesEnd= (volatile uint16_t*)GBA_CHAR_BLOCK(4)-(32*64);

const uint32_t VK_GBA_TILES2_OFF = 0x200;
const uint32_t VK_GBA_TILES3_OFF = 0x280;
const uint32_t VK_GBA_TILES_END_OFF = 0x3C0;

#ifdef VK_256_COLOR
const uint16_t vk_vga_palette[256] = {
	0x67f9, 0x0, 0x400, 0xc00, 0x1000, 0x1c00, 0x2, 0x2400, 0x2c00, 0x3400, 0x20, 0x4800, 0x4, 0x6, 0x23, 0x5401, 0x5000, 0x8, 
	0x441, 0x25, 0x9, 0xa, 0x64, 0x480, 0xe, 0x300b, 0xc63, 0x10, 0x2c, 0x42c, 0x12, 0x14, 0x885, 0x15, 0x1068, 0x4010, 
	0x5c63, 0xc0, 0x10a4, 0x5482, 0x89, 0xa7, 0x4c13, 0xc8a, 0x436, 0x108c, 0x6e, 0x44a5, 0x851, 0x5415, 0x18c6, 0x72, 0x857, 0x473, 
	0x6ca8, 0xcc, 0x5c37, 0x1d07, 0x160, 0x5504, 0x1079, 0xc96, 0xd1, 0x1096, 0x18ee, 0xef, 0x70e7, 0x2128, 0x6507, 0x150b, 0x50c, 0x210c, 
	0x150c, 0x74cc, 0x3180, 0x149a, 0x6478, 0xf5, 0x1cf1, 0x2549, 0x113, 0x6129, 0x512, 0x7129, 0x294a, 0x7529, 0x18d9, 0x133, 0x6183, 0x10f9, 
	0x1cf6, 0x5cd7, 0x1e0, 0xd4f, 0x6cbb, 0x135, 0x216d, 0x55c0, 0x7d4a, 0x7d4b, 0x2d6b, 0x41a6, 0x1cfc, 0x155, 0x39c3, 0x573, 0x2954, 0x174, 
	0x656b, 0x7d6b, 0x318c, 0x2d70, 0x240, 0x593, 0x7d8c, 0x798c, 0x11b1, 0x253c, 0x711c, 0x253e, 0x35cd, 0x4a40, 0x996, 0x2d7a, 0x7dad, 0x257b, 
	0x295f, 0x2a0, 0x9d6, 0x295f, 0x15d6, 0x6243, 0x6627, 0x4629, 0x6e26, 0x1db9, 0x7deb, 0x9f6, 0x5e0b, 0x297f, 0x3e10, 0x69ef, 0x7d5f, 0x259f, 
	0x1613, 0x56a0, 0x319f, 0x722b, 0xae2, 0x39d9, 0x5685, 0x4215, 0x29df, 0x4651, 0x7d9f, 0x1e38, 0x6e31, 0x5ec3, 0x31fc, 0x39df, 0x31fe, 0x1238, 
	0x1e73, 0x29ff, 0x1ee7, 0x4639, 0x7aab, 0x7dff, 0x4e73, 0x3259, 0x1697, 0x421f, 0x2697, 0x76e8, 0x52b1, 0x6305, 0x5295, 0x6b06, 0x169a, 0x52b4, 
	0x56b5, 0x7e3f, 0x670b, 0x2a7f, 0x2d9, 0x6b47, 0x6310, 0x2388, 0x5ad6, 0x7ed6, 0x22db, 0x7768, 0x529f, 0x1afb, 0x22f9, 0x3b4f, 0x7f4c, 0x31a, 
	0x6f4c, 0x2adf, 0x7e9f, 0x5ef7, 0x56fa, 0x7388, 0x6f72, 0x6338, 0x3eff, 0x2bca, 0x2b1f, 0x373c, 0x275b, 0x1f3c, 0x5eff, 0x7bc9, 0x4b1e, 0x2bea, 
	0x2b5d, 0x7739, 0x7375, 0xf7d, 0x37ec, 0x237b, 0x2b5f, 0x6b5a, 0x7fe9, 0x675f, 0x7f5e, 0x2b9f, 0x47f1, 0x27bd, 0x7fee, 0x7ff0, 0x6f9c, 0x2bf5, 
	0x77b9, 0x7ff2, 0x5ff8, 0x5ff7, 0x77bd, 0x7ff5, 0x4bdf, 0x7ff8, 0x2bff, 0x5bdf, 0x3fff, 0x2bff, 0x5fdf, 0x7bde, 0x3bff, 0x33ff, 0x67df, 0x7ffa, 
	0x7ffd, 0x7fff, 0x73ff, 0x7fff
};

const uint16_t vk_gb_palette[256] = {
	0x67f9, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 
	0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 
	0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x4e1, 0x1986, 0x1986, 0x4e1, 0x4e1, 0x1986, 0x4e1, 0x4e1, 0x1986, 0x4e1, 0x1986, 0x4e1, 
	0x4e1, 0x1986, 0x4e1, 0x1986, 0x4e1, 0x4e1, 0x1986, 0x4e1, 0x1986, 0x4e1, 0x1986, 0x4e1, 0x4e1, 0x1986, 0x1986, 0x1986, 0x4e1, 0x1986, 
	0x1986, 0x4e1, 0x1986, 0x1986, 0x1986, 0x1986, 0x4e1, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x6b1, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 
	0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x6b1, 0x4e1, 0x1986, 0x6b1, 0x1986, 0x1986, 0x1986, 0x6b1, 0x6b1, 
	0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x1986, 0x6b1, 0x1986, 0x1986, 0x4e1, 0x1986, 0x6b1, 0x6b1, 0x1986, 0x1986, 
	0x6b1, 0x6b1, 0x1986, 0x1986, 0x1986, 0x6b1, 0x6b1, 0x1986, 0x6b1, 0x4e1, 0x1986, 0x6b1, 0x1986, 0x1986, 0x6b1, 0x1986, 0x6b1, 0x1986, 
	0x6b1, 0x1986, 0x6b1, 0x6b1, 0x1986, 0x6b1, 0x6f3, 0x6b1, 0x1986, 0x1986, 0x6b1, 0x6b1, 0x1986, 0x6b1, 0x1986, 0x6b1, 0x6b1, 0x6b1, 
	0x6f3, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x1986, 0x1986, 0x6b1, 0x1986, 0x6b1, 0x6b1, 0x6f3, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 
	0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6f3, 0x6b1, 0x6b1, 0x1986, 0x6b1, 0x6b1, 0x1986, 0x6b1, 0x6f3, 
	0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6f3, 0x6b1, 0x6b1, 0x6b1, 0x6f3, 0x6f3, 0x6b1, 0x6b1, 
	0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6f3, 0x6b1, 0x6f3, 0x6b1, 0x6b1, 0x6f3, 0x6f3, 0x6b1, 0x6b1, 0x6b1, 0x6b1, 0x6f3, 0x6b1, 0x6f3, 
	0x6f3, 0x6b1, 0x6b1, 0x6b1, 0x6f3, 0x6f3, 0x6f3, 0x6b1, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 
	0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3, 0x6f3
};

const uint16_t vk_greyscale_palette[256] = {
	0x67f9, 0x0, 0x0, 0x421, 0x421, 0x842, 0x0, 0xc63, 0xc63, 0x1084, 0x0, 0x18c6, 0x421, 0x842, 
	0x421, 0x1ce7, 0x18c6, 0x842, 0x421, 0x842, 0xc63, 0xc63, 0x842, 0x421, 0x1084, 0x1ce7, 0xc63, 0x14a5, 0x1084, 0x1084, 0x18c6, 0x18c6, 
	0xc63, 0x1ce7, 0x14a5, 0x294a, 0x2529, 0x842, 0x1084, 0x2529, 0x1084, 0x1084, 0x318c, 0x14a5, 0x2108, 0x18c6, 0x14a5, 0x2529, 0x1ce7, 0x39ce, 
	0x18c6, 0x1ce7, 0x2529, 0x1ce7, 0x35ad, 0x18c6, 0x3def, 0x1ce7, 0xc63, 0x2d6b, 0x294a, 0x2529, 0x1ce7, 0x294a, 0x2529, 0x1ce7, 0x39ce, 0x2108, 
	0x35ad, 0x2108, 0x1ce7, 0x2529, 0x2108, 0x3def, 0x2108, 0x2d6b, 0x4631, 0x2529, 0x294a, 0x2529, 0x2529, 0x39ce, 0x2529, 0x3def, 0x294a, 0x3def, 
	0x318c, 0x2529, 0x35ad, 0x318c, 0x318c, 0x4631, 0x14a5, 0x2529, 0x4e73, 0x294a, 0x294a, 0x2d6b, 0x4631, 0x4631, 0x2d6b, 0x2d6b, 0x39ce, 0x294a, 
	0x294a, 0x294a, 0x35ad, 0x294a, 0x3def, 0x4631, 0x318c, 0x318c, 0x18c6, 0x294a, 0x4a52, 0x4a52, 0x2d6b, 0x3def, 0x56b5, 0x4210, 0x35ad, 0x318c, 
	0x318c, 0x4210, 0x4e73, 0x3def, 0x4631, 0x1ce7, 0x318c, 0x4631, 0x35ad, 0x3def, 0x4210, 0x39ce, 0x4210, 0x3def, 0x4e73, 0x35ad, 0x4210, 0x4631, 
	0x3def, 0x4a52, 0x6318, 0x4631, 0x35ad, 0x39ce, 0x4a52, 0x4a52, 0x2529, 0x4631, 0x3def, 0x4631, 0x4a52, 0x4631, 0x6318, 0x4210, 0x5294, 0x4210, 
	0x4a52, 0x4e73, 0x4e73, 0x3def, 0x3def, 0x4a52, 0x318c, 0x4e73, 0x5294, 0x6739, 0x4e73, 0x4a52, 0x4210, 0x56b5, 0x4631, 0x5294, 0x4e73, 0x4631, 
	0x5294, 0x4a52, 0x4631, 0x5294, 0x56b5, 0x6b5a, 0x5294, 0x5294, 0x3def, 0x4e73, 0x56b5, 0x39ce, 0x5ad6, 0x6739, 0x4e73, 0x56b5, 0x5ef7, 0x4a52, 
	0x4a52, 0x4a52, 0x5ef7, 0x4210, 0x56b5, 0x56b5, 0x6f7b, 0x5ef7, 0x5ef7, 0x56b5, 0x6318, 0x6318, 0x5ef7, 0x4210, 0x56b5, 0x5ad6, 0x5294, 0x5294, 
	0x6739, 0x5ef7, 0x6318, 0x4631, 0x56b5, 0x6b5a, 0x6739, 0x4e73, 0x4a52, 0x5294, 0x5ad6, 0x6b5a, 0x5ef7, 0x6f7b, 0x77bd, 0x5ef7, 0x56b5, 0x5ad6, 
	0x6739, 0x6b5a, 0x6f7b, 0x5294, 0x6f7b, 0x6b5a, 0x6b5a, 0x6739, 0x77bd, 0x6f7b, 0x6b5a, 0x739c, 0x6318, 0x6f7b, 0x6739, 0x6318, 0x739c, 0x7bde, 
	0x6739, 0x6318, 0x739c, 0x77bd, 0x7bde, 0x7fff, 0x7bde, 0x7fff, 
};

#else

const uint16_t vk_ega_palette[4][17] = {
	{ 0x67f9,    0x0, 0x5400,  0x2a0, 0x56a0,  0x15, 0x5415,  0x155, 0x56b5, 0x294a, 0x7d4a, 0x2bea, 0x7fea, 0x295f, 0x7d5f, 0x2bff, 0x7fff },
	{ 0x67f9,    0x0,    0x0,    0x0,    0x0,   0x0,    0x0,    0x0,    0x0, 0x294a, 0x7d4a, 0x2bea, 0x7fea, 0x295f, 0x7d5f, 0x2bff, 0x7fff },
	{ 0x67f9,    0x0,    0x0,    0x0,    0x0,   0x0,    0x0,    0x0,    0x0,    0x0, 0x5400,  0x2a0, 0x56a0,   0x15, 0x5415,  0x155, 0x56b5 },
	{ 0x67f9,    0x0,    0x0,    0x0,    0x0,   0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0 },
};

const uint16_t vk_gb_palette[4][17] = {
	{ 0x67f9,  0x4e1,  0x4e1,  0x6b1,  0x6b1, 0x1986, 0x1986, 0x1986,  0x6b1, 0x1986, 0x1986,  0x6f3,  0x6f3,  0x6b1,  0x6b1,  0x6f3,  0x6f3 },
	{ 0x67f9,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0, 0x1986, 0x1986,  0x6f3,  0x6f3,  0x6b1,  0x6b1,  0x6f3,  0x6f3 },
	{ 0x67f9,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,  0x4e1,  0x4e1,  0x6b1,  0x6b1, 0x1986, 0x1986, 0x1986,  0x6b1 },
	{ 0x67f9,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0 },
};

const uint16_t vk_greyscale_palette[4][17] = {
	{ 0x67f9,   0x0, 0x14a5, 0x4a52, 0x4a52, 0x294a, 0x2d6b, 0x35ad, 0x56b5, 0x294a, 0x35ad, 0x6f7b, 0x739c, 0x4a52, 0x4e73, 0x7bde, 0x7fff },
	{ 0x67f9,   0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0, 0x294a, 0x35ad, 0x6f7b, 0x739c, 0x4a52, 0x4e73, 0x7bde, 0x7fff },
	{ 0x67f9,   0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0, 0x14a5, 0x4a52, 0x4a52, 0x294a, 0x2d6b, 0x35ad, 0x56b5, 0x294a },
	{ 0x67f9,   0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0,    0x0 },
};
#endif

void VK_SetupVideo(){
	int i;
	
	// Setup the video
	*(volatile uint16_t*)GBA_REG_DISPCNT = GBA_MODE_0 | GBA_ENABLE_BG0 | GBA_ENABLE_BG1 | GBA_SPRITE_ENABLE | GBA_SPRITE_MAP_1D;

	// Copy the palette
#ifdef VK_256_COLOR
	GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_vga_palette,256);
	GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_vga_palette,256);
#else
	GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_ega_palette[0],17);
	GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_ega_palette[0],17);
#endif
	
	// Clear all the tiles to blank
	GBA_DMA_MemSet32((uint32_t*)GBA_VRAM,0,128*128);


	// Clear the maps
	for(i = 0; i < 32*32; i++){
		VK_GBA_BG_MAPA[i] = 0;
		VK_GBA_BG_MAPB[i] = 0;
	}
	
	//GBA_BLEND_BGS(GBA_BLD_S_SPR | GBA_BLDM_APLHA |  GBA_BLD_D_BG3 |  GBA_BLD_D_BG2 |  GBA_BLD_D_BG1)
	
	// Setup two backgrounds as 64x64 size
	GBA_FINISH_BG0(GBA_BG_FRONT | 0x00 | (30 << 8) | GBA_BG_SIZE_32x32 | GBA_BG_WRAP);
	GBA_FINISH_BG1(GBA_BG_TOP   | 0x00 | (31 << 8) | GBA_BG_SIZE_32x32 | GBA_BG_WRAP);

	// "Hide" all the sprites
	GBA_HideSprites();

	// Show the sprite
	GBA_UPDATE_SPRITES()
};


void VK_WaitVRB(){
	GBA_WAIT_FOR_VBLANK
	// Wait again
	GBA_WAIT_VBLANK
};

void VK_SetPalette(uint16_t offset){
#ifdef VK_256_COLOR
	if(vk_engine_gstate.gba_palette==0){
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_vga_palette,256);
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_vga_palette,256);
	}
	if(vk_engine_gstate.gba_palette==1){
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_gb_palette,256);
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_gb_palette,256);
	}
	if(vk_engine_gstate.gba_palette==2){
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_greyscale_palette,256);
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_greyscale_palette,256);
	}
#else

	if(vk_engine_gstate.gba_palette==0){
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_ega_palette[offset],17);
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_ega_palette[offset],17);
	}
	if(vk_engine_gstate.gba_palette==1){
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_gb_palette[offset],17);
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_gb_palette[offset],17);
	}
	if(vk_engine_gstate.gba_palette==2){
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_greyscale_palette[offset],17);
		GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_greyscale_palette[offset],17);
	}

#endif
};

void VK_FadeOut(){
#ifdef VK_256_COLOR
	int i, fadev;
	uint16_t *palette = &vk_vga_palette;
	if(vk_engine_gstate.gba_palette==1){
		palette = &vk_gb_palette;
	}
	if(vk_engine_gstate.gba_palette==2){
		palette = &vk_greyscale_palette;
	}
	for(fadev = 0; fadev < 32; fadev ++){
		for(i = 0; i < 256; i++){
			int16_t fadecol = 0,color = 0;
			color = ((palette[i]>>10)&0x1F) - fadev;
			if(color < 0) color = 0;
			fadecol |= color << 10;
			color = ((palette[i]>>5)&0x1F) - fadev;
			if(color < 0) color = 0;
			fadecol |= color << 5;
			color = ((palette[i])&0x1F) - fadev;
			if(color < 0) color = 0;
			fadecol |= color ;
			((uint16_t*)GBA_PAL_BG_START)[i] = fadecol;
			((uint16_t*)GBA_PAL_SPR_START)[i] = fadecol;
		}
		GBA_Delay(64);
	}
#else

	// Swap the palettes to the next one
	int fadev = 0;
	
	for(fadev = 0; fadev < 4; fadev++){
		// Copy the palette
		if(vk_engine_gstate.gba_palette==0){
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_ega_palette[fadev],17);
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_ega_palette[fadev],17);
		}
		if(vk_engine_gstate.gba_palette==1){
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_gb_palette[fadev],17);
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_gb_palette[fadev],17);
		}
		if(vk_engine_gstate.gba_palette==2){
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_greyscale_palette[fadev],17);
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_greyscale_palette[fadev],17);
		}		
		GBA_Delay(250);
	}
#endif
};

void VK_FadeIn(){
#ifdef VK_256_COLOR
	int i, fadev;
	uint16_t *palette = &vk_vga_palette;
	if(vk_engine_gstate.gba_palette==1){
		palette = &vk_gb_palette;
	}
	if(vk_engine_gstate.gba_palette==2){
		palette = &vk_greyscale_palette;
	}
	for(fadev = 31; fadev >=0; fadev --){
		for(i = 0; i < 256; i++){
			int16_t fadecol = 0,color = 0;
			color = ((palette[i]>>10)&0x1F) - fadev;
			if(color < 0) color = 0;
			fadecol |= color << 10;
			color = ((palette[i]>>5)&0x1F) - fadev;
			if(color < 0) color = 0;
			fadecol |= color << 5;
			color = ((palette[i])&0x1F) - fadev;
			if(color < 0) color = 0;
			fadecol |= color ;
			((uint16_t*)GBA_PAL_BG_START)[i] = fadecol;
			((uint16_t*)GBA_PAL_SPR_START)[i] = fadecol;
		}
		GBA_Delay(64);
	}
#else

	// Swap the palettes to the next one
	int fadev = 0;
	
	for(fadev = 2; fadev >= 0; fadev-=2){
		// Copy the palette
		if(vk_engine_gstate.gba_palette==0){
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_ega_palette[fadev],17);
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_ega_palette[fadev],17);
		}
		if(vk_engine_gstate.gba_palette==1){
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_gb_palette[fadev],17);
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_gb_palette[fadev],17);
		}
		if(vk_engine_gstate.gba_palette==2){
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_BG_START,(uint16_t*)vk_greyscale_palette[fadev],17);
			GBA_DMA_Copy16((uint16_t*)GBA_PAL_SPR_START,(uint16_t*)vk_greyscale_palette[fadev],17);
		}
					
		GBA_Delay(250);
	}
#endif
};

uint16_t VK_TextX = 0;
uint16_t VK_TextY = 0;


void VK_PrintTXT(char *string){
	uint16_t offset = 0;

	uint16_t VK_TextInv = 0x2E0;

	while(*string!=0x00){
		
		if((*string)==126){
			VK_TextInv = 0x360;
			string++;
		}else if((*string)==31){
			string++;
			while(offset<28){
				// Draw blank
				VK_GBA_BG_MAPA[(VK_TextY<<5)+VK_TextX+offset] = VK_TextInv;
				offset++;
			}
			return;
		}else{
			// Draw the letter
			VK_GBA_BG_MAPA[(VK_TextY<<5)+VK_TextX+offset] = VK_TextInv+(*string)-' ';
			if((*string)<' '||(*string)>'z'+2){
				string++;
			}
			offset++;
		}
		if(offset>=28){
			return ; //STOP THE STRING!
		}
		string++;
	}
	while(offset<28){
		// Draw blank
		VK_GBA_BG_MAPA[(VK_TextY<<5)+VK_TextX+offset] = VK_TextInv;
		offset++;
	}
};

void VK_Print(char *string){
	uint16_t offset = 0;

	while(*string!=0x00){
		// Draw the letter
		VK_GBA_BG_MAPA[(VK_TextY<<5)+VK_TextX+offset] = 0x2E0+(*string)-' ';
		offset++;
		string++;
	}
};

void VK_Print2(char *string){
	uint16_t offset = 0;
	while(*string!=0x00){
		// Draw the letter
		VK_GBA_BG_MAPA[(VK_TextY<<5)+VK_TextX+offset] = 0x360+(*string)-' ';
		string++;
		offset++;
	}
};

void VK_Type(char *string){
	uint16_t offset = 0;

	while(*string!=0x00){
		// Draw the letter
		VK_GBA_BG_MAPA[(VK_TextY<<5)+VK_TextX+offset] = 0x2E0+(*string)-' ';
		offset++;
		string++;
		GBA_Delay(250); // Wait ~ 250ms for each letter
	}
};

char vk_iota_str[256];

char * VK_Iota16(int32_t val){
	int16_t i = 0, e = 0;
	if(val==0){
		vk_iota_str[0] = '0';
		vk_iota_str[1] = 0;
		return vk_iota_str;
	}
	if(val < 0){
		val = -val;
		vk_iota_str[i++] = '-';
	}
	i = 0;
	while(val){
		char hexv = '0';
		for(e = 0; e < 16; e++){
			if(e==(val&0xF)){
				hexv = "0123456789ABCDEF"[e];
				break;
			}
		}
		for(e = i; e >=1; e--)
			vk_iota_str[e] = vk_iota_str[e-1];
		i ++;
		vk_iota_str[0] = hexv;
		val >>= 4;
	}
	// End the string
	vk_iota_str[i] = 0;
	return vk_iota_str;
};


char * VK_Iota(int32_t val){
	uint16_t i = 0, e = 0;
	
	if(val==0){
		vk_iota_str[0] = '0';
		vk_iota_str[1] = 0;
		return vk_iota_str;
	}
	i = 0;
	if(val < 0){
		val = -val;
		vk_iota_str[i++] = '-';
	}
	while(val){
		char decv = '0'+(val%10);
		
		for(e = i; e >=1; e--)
			vk_iota_str[e] = vk_iota_str[e-1];
		i ++;
		vk_iota_str[0] = decv;
		val /= 10;
	}

	// End the string
	vk_iota_str[i] = 0;
	return vk_iota_str;
};



